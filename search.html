<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="language" content="ko">
    <title>ê³„ì•½ì„œ ì¡°íšŒ</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <style>
        /* ë¡œê³  ë°˜ì§ì´ëŠ” íš¨ê³¼ */
        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .logo-container {
            position: relative;
            display: inline-block;
        }

        .logo-container::after {
            content: "";
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(90deg,
                    rgba(192, 192, 192, 0) 0%,
                    rgba(192, 192, 192, 0.1) 20%,
                    rgba(211, 211, 211, 0.5) 50%,
                    rgba(192, 192, 192, 0.1) 80%,
                    rgba(192, 192, 192, 0) 100%);
            background-size: 200% 100%;
            border-radius: 10px;
            z-index: 1;
            animation: shimmer 5s infinite linear;
            pointer-events: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            min-width: 250px;
        }

        .notification.success {
            background-color: #28a745;
        }

        .notification.error {
            background-color: #dc3545;
        }

        .notification.show {
            opacity: 1;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin-top: -150px;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        .card-body {
            padding: 2rem;
        }

        .btn {
            width: 100%;
            margin-bottom: 1rem;
            padding: 1rem;
            font-size: 1.1rem;
        }

        .image-preview {
            max-width: 100%;
            max-height: 500px;
            margin-top: 1rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            display: none;
            object-fit: contain;
        }

        #search-results {
            margin-top: 1rem;
        }

        .receipt-preview {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .receipt-image {
            max-width: 100%;
            height: 150px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        /* Mobile responsive styles */
        @media (max-width: 480px) {
            .card {
                max-width: 90%;
                margin: 0 auto;
            }

            .receipt-image {
                height: 100px;
            }
        }

        /* Tablet responsive styles */
        @media (min-width: 481px) and (max-width: 1024px) {
            .receipt-image {
                height: 120px;
            }
        }
        .result-item {
            border: 1px solid #ccc;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="logo-container">
                        <img src="BDSR.png" alt="BDSR ë¡œê³ "
                            style="max-width: 150px; margin: 20px 10px;  position: relative; z-index: 2;">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">ì´ë¦„</label>
                    <input type="text" class="form-control" id="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <div class="mb-3 row">
                    <div class="col-6">
                        <label class="form-label">ìƒë…„ì›”ì¼</label>
                        <input type="text" class="form-control" id="birthdate" placeholder="ì˜ˆ: 19901010">
                    </div>
                    <div class="col-6">
                        <label class="form-label">ê´€ë¦¬ì ì½”ë“œ</label>
                        <input type="password" class="form-control" id="admin-code" placeholder="ê´€ë¦¬ì ì½”ë“œ ì…ë ¥">
                    </div>
                </div>
                <div class="mb-3 text-center" style="font-size: 0.8rem; color: #6c757d;">
                    * ìƒë…„ì›”ì¼ ë˜ëŠ” ê´€ë¦¬ì ì½”ë“œ ì¤‘ í•˜ë‚˜ëŠ” í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤
                </div>

                <button id="search-btn" class="btn btn-primary">ê³„ì•½ì„œ ì¡°íšŒ</button>

                <div id="search-results" class="mt-4" style="display: none;">
                    <div id="results-section" style="display: none;">
                        <div id="results-container"></div>
                    </div>
                    <div class="alert alert-info" id="result-message"></div>

                    <div id="contract-section" style="display: none;">
                        <img id="contract-image" class="image-preview" style="display: block;">
                        <button id="download-contract" class="btn btn-success mt-2">ê³„ì•½ì„œ ë‹¤ìš´ë¡œë“œ</button>
                    </div>

                    <div id="receipts-section" style="display: none;">
                        <div id="receipt-images" class="receipt-preview"></div>
                        <button id="download-all-receipts" class="btn btn-success mt-2">ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                </div>
                <div id="status"></div>
                <div class="d-flex justify-content-center">

                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        let db, storage;

        async function initializeFirebase() {
            try {
                const response = await fetch("https://us-central1-bodystar-1b77d.cloudfunctions.net/getFirebaseConfig");
                const firebaseConfig = await response.json();
                console.log("Firebase ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì„±ê³µ");

                // Firebase ì´ˆê¸°í™”
                const app = firebase.initializeApp(firebaseConfig, "search-app-instance");
                db = firebase.firestore(app);
                storage = firebase.storage(app);

                console.log("âœ… Firestore ì´ˆê¸°í™” ì™„ë£Œ: Firestore");
                console.log("âœ… Firebase Auth ì´ˆê¸°í™” ì™„ë£Œ: AuthImpl");

                return true;
            } catch (error) {
                console.error("Firebase ì„¤ì • ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", error);
                if (document.getElementById("status")) {
                    document.getElementById("status").innerText = "Firebase ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                }
                throw error;
            }
        }

        // DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ì— Firebase ì´ˆê¸°í™”ì™€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                await initializeFirebase();
                // ì•½ê°„ì˜ ì§€ì—°ì„ ì£¼ì–´ ëª¨ë“  ìš”ì†Œê°€ ì™„ì „íˆ ë¡œë“œë˜ë„ë¡ í•¨
                setTimeout(() => {
                    setupEventListeners();
                }, 100);
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                if (document.getElementById("status")) {
                    document.getElementById("status").innerText = "Firebase ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                }
            }
        });

        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showNotification(message, type) {
            // Check if notification element already exists
            let notification = document.getElementById('notification');

            // If not, create it
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.className = 'notification';
                document.body.appendChild(notification);
            }

            // Add appropriate class for styling
            notification.className = 'notification ' + type;

            // Set notification content
            notification.innerHTML = message;

            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            // Hide after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
        async function downloadImage(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                return true;
            } catch (error) {
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                showNotification('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                return false;
            }
        }

        // ë‚ ì§œ í¬ë§· ë³€í™˜ (YYYY-MM-DD -> YYMMDD)
        function formatDateForSearch(dateString) {
            if (!dateString) return null;

            // ìˆ«ìë§Œ ë‚¨ê¸°ê³  ê¸¸ì´ í™•ì¸
            const digits = dateString.replace(/\D/g, '');

            if (digits.length === 8) {
                // YYYYMMDD -> YYYY-MM-DD ë³€í™˜
                return `${digits.substring(0, 4)}-${digits.substring(4, 6)}-${digits.substring(6, 8)}`;
            }

            return null;
        }


        function setupEventListeners() {
                const searchBtn = document.getElementById('search-btn');
                const nameInput = document.getElementById('name');
                const birthdateInput = document.getElementById('birthdate');
                const searchResults = document.getElementById('search-results');
                const resultMessage = document.getElementById('result-message');
                const contractSection = document.getElementById('contract-section');
                const contractImage = document.getElementById('contract-image');
                const downloadContract = document.getElementById('download-contract');
                const receiptsSection = document.getElementById('receipts-section');
                const receiptImages = document.getElementById('receipt-images');
                const downloadAllReceipts = document.getElementById('download-all-receipts');
                const returnHomeBtn = document.getElementById('return-home');
                const resultsSection = document.getElementById('results-section');
                const resultsContainer = document.getElementById('results-container'); // Added

                // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                searchBtn.addEventListener('click', async function () {
                    const name = nameInput.value.trim();
                    let birthdate = birthdateInput.value.trim();

                    if (!name) {
                        showNotification('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                        return;
                    }

                    const adminCode = document.getElementById('admin-code').value.trim();
                    if (!birthdate && !adminCode) {
                        showNotification('ìƒë…„ì›”ì¼ ë˜ëŠ” ê´€ë¦¬ìì½”ë“œ ì¤‘ í•˜ë‚˜ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.', 'error');
                        return;
                    }

                    // ğŸ”¹ ìƒë…„ì›”ì¼ì„ Firestore ì €ì¥ í˜•ì‹ (YYYY-MM-DD)ìœ¼ë¡œ ë³€í™˜
                    if (birthdate) {
                        birthdate = formatDateForSearch(birthdate);
                    }

                    try {
                        let query;

                        if (birthdate) {
                            // ğŸ”¹ ì´ë¦„ + ë³€í™˜ëœ ìƒë…„ì›”ì¼ë¡œ ê²€ìƒ‰
                            query = db.collection("Membership").where("name", "==", name).where("birthdate", "==", birthdate);
                        } else if (adminCode) {
                            // ğŸ”¹ ì´ë¦„ + ê´€ë¦¬ì ì½”ë“œë¡œ ê²€ìƒ‰ (ì´ë¦„ë§Œ ë§¤ì¹˜)
                            query = db.collection("Membership").where("name", "==", name);
                        }

                        if (!query) {
                            throw new Error('ê²€ìƒ‰ ì¡°ê±´ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                        }

                        const querySnapshot = await query.get();
                    } catch (error) {
                        console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                        showNotification('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }


                        // ê²€ìƒ‰ ê²°ê³¼ ì´ˆê¸°í™”
                        searchResults.style.display = 'block'; //Always show search results container
                        resultsSection.style.display = 'none'; //Initially hide results
                        contractSection.style.display = 'none';
                        receiptsSection.style.display = 'none';
                        contractImage.src = '';
                        contractImage.style.display = 'none'; // ì´ë¯¸ì§€ í‘œì‹œ ì´ˆê¸°í™”
                        receiptImages.innerHTML = '';
                        resultsContainer.innerHTML = ''; //Clear previous results
                        resultMessage.innerHTML = ''; //Clear previous messages


                        // ë¡œë”© í‘œì‹œ
                        searchBtn.disabled = true;
                        searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ê²€ìƒ‰ ì¤‘...';

                        try {
                            console.log('ê²€ìƒ‰ ì‹œì‘:', name, birthdate);
                            // ê²€ìƒ‰ ì¤‘ íŒì—… ì œê±°

                            // ë¡œê·¸ì— ì ‘ê·¼ í† í° ì¶œë ¥ (ì¸ì¦ ì´ìŠˆ í™•ì¸ìš©)
                            storage.ref().toString();

                            // í˜„ì¬ ì—°ë„ ê°€ì ¸ì˜¤ê¸° (2023ë¶€í„° ì‹œì‘ìœ¼ë¡œ í™•ì¥)
                            const startYear = 2023;
                            const currentYear = new Date().getFullYear();
                            const years = [];

                            // 2023ë…„ë¶€í„° í˜„ì¬ ì—°ë„ê¹Œì§€ì˜ ë°°ì—´ ìƒì„±
                            for (let year = startYear; year <= currentYear; year++) {
                                years.push(year.toString());
                            }

                            // AdminSettingsì—ì„œ ì§€ì  ëª©ë¡ì„ ê°€ì ¸ì˜´
                            const branchesSnapshot = await db.collection("AdminSettings").doc("settings").get();
                            let branches = ["ê´€ì €ì ", "ìœ ì„±ì ", "ë‘”ì‚°ì ", "ë„ì•ˆì ", "ë…¸ì€ì ", "ì§„ì ì ", "ëŒ€ì „ì„¼í„°"]; // ê¸°ë³¸ê°’

                            if (branchesSnapshot.exists) {
                                const settingsData = branchesSnapshot.data();
                                if (settingsData && settingsData.branch) {
                                    branches = Object.keys(settingsData.branch);
                                    console.log("AdminSettingsì—ì„œ ì§€ì  ëª©ë¡ ë¡œë“œ:", branches);
                                } else {
                                    console.warn("AdminSettingsì— branch ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©");
                                }
                            } else {
                                console.warn("AdminSettings/settings ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ ì‚¬ìš©");
                            }

                            // ê²°ê³¼ë¥¼ ë‹´ì„ ë°°ì—´
                            const filteredResults = [];

                            // ê° ì§€ì ê³¼ ì—°ë„ ì¡°í•©ìœ¼ë¡œ ê²€ìƒ‰
                            for (const branch of branches) {
                                for (const year of years) {
                                    try {
                                        // ìƒˆ í´ë” êµ¬ì¡°ì— ë§ê²Œ ì—¬ëŸ¬ ì»¬ë ‰ì…˜ ì¡°íšŒ
                                        // 1. Membership ì»¬ë ‰ì…˜ (ê¸°ë³¸)
                                        const queryMembership = db.collection(branch).doc(year).collection("Membership").where("name", "==", name);
                                        const querySnapshotMembership = await queryMembership.get();

                                        if (!querySnapshotMembership.empty) {
                                            console.log(`${branch}/${year}/Membership ê²€ìƒ‰ ê²°ê³¼:`, querySnapshotMembership.size);

                                            querySnapshotMembership.forEach((doc) => {
                                                const data = doc.data();
                                                console.log('Membership ë¬¸ì„œ ë°ì´í„°:', data.name, data.birthdate);

                                                // ìƒë…„ì›”ì¼ í¬ë§·íŒ… ë° ë¡œê¹… ì¶”ê°€
                                                console.log(`ë¹„êµ: DBë°ì´í„°(${data.birthdate}) vs ì…ë ¥ë°ì´í„°(${birthdate})`);
                                                const cleanDBBirthdate = data.birthdate ? data.birthdate.replace(/[^0-9]/g, '') : '';
                                                const cleanInputBirthdate = birthdate ? birthdate.replace(/[^0-9]/g, '') : '';

                                                // ë§Œì•½ DBì˜ ìƒë…„ì›”ì¼ì´ 8ìë¦¬(YYYYMMDD)ì¸ë°, ì…ë ¥ì€ 6ìë¦¬(YYMMDD)ì¸ ê²½ìš° í˜•ì‹ í†µì¼
                                                let formattedDBBirthdate = cleanDBBirthdate;
                                                if (cleanDBBirthdate.length === 8 && cleanInputBirthdate.length === 6) {
                                                    formattedDBBirthdate = cleanDBBirthdate.substring(2); // YYYYMMDD -> YYMMDD
                                                }

                                                console.log(`ì •ì œëœ ë¹„êµ: DB(${cleanDBBirthdate} -> ${formattedDBBirthdate}) vs ì…ë ¥(${cleanInputBirthdate})`);

                                                // ê´€ë¦¬ì ì½”ë“œ í™•ì¸
                                                const adminCode = document.getElementById('admin-code').value.trim();

                                                // ìƒë…„ì›”ì¼ ê²€ì¦ ë¡œì§
                                                // 1. ê´€ë¦¬ì ì½”ë“œê°€ ìˆìœ¼ë©´ ìƒë…„ì›”ì¼ ê²€ì¦ ì—†ì´ í†µê³¼
                                                // ê´€ë¦¬ì ì½”ë“œê°€ ìˆê±°ë‚˜ ìƒë…„ì›”ì¼ì´ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ì—ë§Œ ê²°ê³¼ì— í¬í•¨
                                                if (adminCode || 
                                                    (cleanInputBirthdate && cleanDBBirthdate && (
                                                        cleanDBBirthdate === cleanInputBirthdate || 
                                                        formattedDBBirthdate === cleanInputBirthdate
                                                    ))) {
                                                    console.log(`âœ… ì¼ì¹˜: ${data.name} (${data.birthdate})`);
                                                    filteredResults.push({doc, data});
                                                } else {
                                                    console.log(`âŒ ë¶ˆì¼ì¹˜: ${data.name} - ìƒë…„ì›”ì¼ì´ ë‹¤ë¦…ë‹ˆë‹¤`);
                                                }
                                            });
                                        }

                                        // Onetimepass ì»¬ë ‰ì…˜ì€ ì œì™¸í•˜ê³  Membership ì»¬ë ‰ì…˜ì—ì„œë§Œ ê²€ìƒ‰í•©ë‹ˆë‹¤
                                        console.log(`${branch}/${year} Membership ì»¬ë ‰ì…˜ì—ì„œë§Œ ê²€ìƒ‰í•©ë‹ˆë‹¤`);
                                    } catch (error) {
                                        console.log(`${branch}/${year} ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜:`, error);
                                        // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰
                                    }
                                }
                            }

                            // í´ë”êµ¬ì¡° ë³€ê²½ ì „ ê¸°ì¡´ ë°ì´í„°ë„ ê²€ìƒ‰ (ë§ˆì´ê·¸ë ˆì´ì…˜ ê¸°ê°„ ì¤‘)
                            try {
                                const legacyQuery = db.collection("Membership").where("name", "==", name);
                                const legacyQuerySnapshot = await legacyQuery.get();

                                if (!legacyQuerySnapshot.empty) {
                                    console.log('ê¸°ì¡´ êµ¬ì¡°ì—ì„œ ê²€ìƒ‰ ê²°ê³¼:', legacyQuerySnapshot.size);

                                    try {
                                        legacyQuerySnapshot.forEach((doc) => {
                                            const data = doc.data();
                                            console.log('ê¸°ì¡´ ë¬¸ì„œ ë°ì´í„°:', data.name, data.birthdate);

                                            // ìƒë…„ì›”ì¼ í¬ë§·íŒ… ë° ë¡œê¹… ì¶”ê°€
                                            console.log(`ë¹„êµ: DBë°ì´í„°(${data.birthdate}) vs ì…ë ¥ë°ì´í„°(${birthdate})`);

                                            // ìƒë…„ì›”ì¼ ë°ì´í„° ì •ì œ (ìˆ«ìë§Œ ì¶”ì¶œ)
                                            const cleanDBBirthdate = data.birthdate ? data.birthdate.replace(/[^0-9]/g, '') : '';
                                            const cleanInputBirthdate = birthdate ? birthdate.replace(/[^0-9]/g, '') : '';

                                            // ë§Œì•½ DBì˜ ìƒë…„ì›”ì¼ì´ 8ìë¦¬(YYYYMMDD)ì¸ë°, ì…ë ¥ì€ 6ìë¦¬(YYMMDD)ì¸ ê²½ìš° í˜•ì‹ í†µì¼
                                            let formattedDBBirthdate = cleanDBBirthdate;
                                            if (cleanDBBirthdate.length === 8 && cleanInputBirthdate.length === 6) {
                                                formattedDBBirthdate = cleanDBBirthdate.substring(2); // YYYYMMDD -> YYMMDD
                                            }

                                            // ê´€ë¦¬ì ì½”ë“œ í™•ì¸
                                            const adminCode = document.getElementById('admin-code').value.trim();

                                            // ìƒë…„ì›”ì¼ ê²€ì¦ ë¡œì§
                                            // 1. ê´€ë¦¬ì ì½”ë“œê°€ ìˆìœ¼ë©´ ìƒë…„ì›”ì¼ ê²€ì¦ ì—†ì´ í†µê³¼
                                            // 2. ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
                                            // 3. í˜•ì‹ì„ í†µì¼í–ˆì„ ë•Œ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
                                            if (adminCode) {
                                                console.log(`âœ… ê´€ë¦¬ì ì½”ë“œ ì…ë ¥ë¨ -> ì´ë¦„ë§Œ ë§¤ì¹­ë¨`);
                                                filteredResults.push({doc, data});
                                            } else {
                                                if (!cleanInputBirthdate) {
                                                    console.log(`âŒ ìƒë…„ì›”ì¼ ë¯¸ì…ë ¥ -> ê²°ê³¼ì—ì„œ ì œì™¸`);
                                                } else if (!cleanDBBirthdate) {
                                                    console.log(`âŒ ë°ì´í„°ë² ì´ìŠ¤ì— ìƒë…„ì›”ì¼ ì—†ìŒ -> ê²°ê³¼ì—ì„œ ì œì™¸`);
                                                } else if (cleanDBBirthdate === cleanInputBirthdate || formattedDBBirthdate === cleanInputBirthdate) { 
                                                    console.log(`âœ… ì´ë¦„ + ìƒë…„ì›”ì¼ ë§¤ì¹­ë¨: ${data.name} (${data.birthdate})`);
                                                    filteredResults.push({doc, data});
                                                } else {
                                                    console.log(`âŒ ìƒë…„ì›”ì¼ ë¶ˆì¼ì¹˜ -> ê²°ê³¼ì—ì„œ ì œì™¸`);
                                                }
                                            }

                                        });
                                    } catch (error) {
                                        console.error("Error processing legacyQuerySnapshot:", error);
                                    }
                                }

                                // ë¬¸ì„œ IDë¡œ ì§ì ‘ ê²€ìƒ‰ ì‹œë„ (ë‚ ì§œ_ë²ˆí˜¸_ì´ë¦„ í˜•ì‹)
                                console.log("ë¬¸ì„œ IDë¡œ ì§ì ‘ ê²€ìƒ‰ ì‹œë„...");
                                // ê° ì§€ì  ìˆœíšŒ
                                for (const branch of branches) {
                                    for (const year of years) {
                                        try {
                                            // ì´ë¦„ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ë¬¸ì„œ ì°¾ê¸°
                                            const snapshots = await db.collection(branch).doc(year).collection("Membership")
                                                .where("name", "==", name)
                                                .get();

                                            if (!snapshots.empty) {
                                                console.log(`${branch}/${year} ë¬¸ì„œ IDë¡œ ê²€ìƒ‰ ê²°ê³¼:`, snapshots.size);
                                                snapshots.forEach(doc => {
                                                    const data = doc.data();
                                                    // ì´ë¯¸ ê²°ê³¼ì— ì¶”ê°€ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì¶”ê°€
                                                    if (!filteredResults.some(item => item.doc.id === doc.id)) {
                                                        console.log(`ë¬¸ì„œ IDë¡œ ì°¾ìŒ: ${doc.id}`);
                                                        filteredResults.push({doc, data});
                                                    }
                                                });
                                            }
                                        } catch (error) {
                                            console.log(`${branch}/${year} ë¬¸ì„œ ID ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜:`, error);
                                        }
                                    }
                                }
                            } catch (error) {
                                console.log('ê¸°ì¡´ êµ¬ì¡° ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜:', error);
                                // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰
                            }

                            if (filteredResults.length === 0) {
                                resultMessage.innerHTML = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
                                resultMessage.style.display = 'block';
                                // Notification popup removed as requested
                            } else {
                                let foundResults = filteredResults.length;
                                resultMessage.innerHTML = `${foundResults}ê°œì˜ ê²°ê³¼ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
                                resultMessage.style.display = 'block';
                                // 3ì´ˆ í›„ì— ê²°ê³¼ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                                setTimeout(() => {
                                    resultMessage.style.display = 'none';
                                }, 3000);

                                // ê° ê²°ê³¼ì— ëŒ€í•´ ì²˜ë¦¬
                                let resultsHTML = '';
                                filteredResults.forEach(({doc, data}) => {
                                    const membershipDate = data.timestamp ? new Date(data.timestamp).toLocaleDateString('ko-KR') : 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';

                                    // imageUrl ì •ë³´ ì¶”ì¶œ
                                    const hasImage = data.imageUrl ? true : false;

                                    resultsHTML += `
                                    <div class="result-item" data-docid="${doc.id}" data-collection="${data.collection || 'Membership'}" data-imageurl="${data.imageUrl || ''}">
                                        <div class="result-header">
                                            <h5>${data.name} (${data.birthdate || 'ìƒë…„ì›”ì¼ ì •ë³´ ì—†ìŒ'})</h5>
                                            <span class="badge bg-primary">${data.branch || 'ì§€ì  ì •ë³´ ì—†ìŒ'}</span>
                                            <span class="badge ${hasImage ? 'bg-success' : 'bg-danger'}">${hasImage ? 'ì´ë¯¸ì§€ ìˆìŒ' : 'ì´ë¯¸ì§€ ì—†ìŒ'}</span>
                                        </div>
                                        <p><strong>ë¬¸ì„œ ID:</strong> ${doc.id}</p>
                                        <p><strong>ì—°ë½ì²˜:</strong> ${data.contact || 'ì—°ë½ì²˜ ì •ë³´ ì—†ìŒ'}</p>
                                        <p><strong>ë“±ë¡ì¼:</strong> ${membershipDate}</p>
                                        <p><strong>íšŒì›ê¶Œ:</strong> ${data.membership || 'íšŒì›ê¶Œ ì •ë³´ ì—†ìŒ'}</p>
                                        <p><strong>ì£¼ì†Œ:</strong> ${data.address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</p>
                                        <div class="action-buttons" style="width: 100%; justify-content: space-between;">
                                            ${hasImage ? 
                                              `<div style="display: flex; flex-direction: column; gap: 5px; margin-right: 10px; width: 48%;">
                                                 <a href="${data.imageUrl}" target="_blank" class="btn btn-primary btn-sm" style="width: 100%;">ê³„ì•½ì„œ ë³´ê¸°</a>
                                                 <button class="btn btn-info btn-sm download-contract-btn" data-url="${data.imageUrl}" data-name="${data.name}" style="width: 100%; padding-top: 0.25rem; padding-bottom: 0.25rem;">ê³„ì•½ì„œ ë‹¤ìš´ë¡œë“œ</button>
                                               </div>` : 
                                              `<div style="width: 48%;"><button class="btn btn-secondary btn-sm" disabled style="width: 100%;">ê³„ì•½ì„œ ì—†ìŒ</button></div>`
                                            }
                                            <div style="display: flex; flex-direction: column; gap: 5px; width: 48%;">
                                              <button class="btn btn-primary btn-sm view-receipt-btn" style="width: 100%;">ì˜ìˆ˜ì¦ ë³´ê¸°</button>
                                              <button class="btn btn-info btn-sm download-receipt-btn" style="width: 100%; padding-top: 0.25rem; padding-bottom: 0.25rem;">ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ</button>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                });

                                resultsContainer.innerHTML = resultsHTML;
                                resultsSection.style.display = 'block';

                                // ê³„ì•½ì„œ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                                document.querySelectorAll('.download-contract-btn').forEach(btn => {
                                    btn.addEventListener('click', function() {
                                        const url = this.dataset.url;
                                        const name = this.dataset.name;
                                        if (url) {
                                            downloadImage(url, `${name}_ê³„ì•½ì„œ.jpg`);
                                            showNotification('ê³„ì•½ì„œ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', 'success');
                                        } else {
                                            showNotification('ê³„ì•½ì„œ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                                        }
                                    });
                                });

                                // ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                                document.querySelectorAll('.download-receipt-btn').forEach(btn => {
                                    btn.addEventListener('click', async function() {
                                        const resultItem = this.closest('.result-item');
                                        const docId = resultItem.dataset.docid;
                                        const collection = resultItem.dataset.collection || 'Membership';
                                        const name = resultItem.querySelector('h5').textContent.split(' ')[0];

                                        try {
                                            // ë¬¸ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                                            const docRef = db.collection(collection).doc(docId);
                                            const docSnapshot = await docRef.get();

                                            if (docSnapshot.exists) {
                                                const data = docSnapshot.data();

                                                if (data.receipts && data.receipts.length > 0) {
                                                    // ëª¨ë“  ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ
                                                    let success = true;
                                                    for (let i = 0; i < data.receipts.length; i++) {
                                                        if (data.receipts[i].url) {
                                                            const result = await downloadImage(data.receipts[i].url, `${name}_ì˜ìˆ˜ì¦${i + 1}.jpg`);
                                                            if (!result) success = false;
                                                        }
                                                    }

                                                    if (success) {
                                                        showNotification('ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', 'success');
                                                    }
                                                } else {
                                                    showNotification('ì˜ìˆ˜ì¦ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                                                }
                                            } else {
                                                showNotification('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                                            }
                                        } catch (error) {
                                            console.error('ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                                            showNotification('ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                                        }
                                    });
                                });

                                // ì˜ìˆ˜ì¦ ë³´ê¸° ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                                document.querySelectorAll('.view-receipt-btn').forEach(btn => {
                                    btn.addEventListener('click', async function() {
                                        const resultItem = this.closest('.result-item');
                                        const docId = resultItem.dataset.docid;
                                        const collection = resultItem.dataset.collection || 'Membership';

                                        // ì˜ìˆ˜ì¦ ì„¹ì…˜ ì´ˆê¸°í™”
                                        receiptImages.innerHTML = '';
                                        receiptsSection.style.display = 'none';

                                        try {
                                            // ë¬¸ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                                            const docRef = db.collection(collection).doc(docId);
                                            const docSnapshot = await docRef.get();

                                            if (docSnapshot.exists) {
                                                const data = docSnapshot.data();

                                                if (data.receipts && data.receipts.length > 0) {
                                                    receiptsSection.style.display = 'block';

                                                    data.receipts.forEach((receipt, index) => {
                                                        if (receipt.url) {
                                                            const imgContainer = document.createElement('div');
                                                            const img = document.createElement('img');
                                                            img.src = receipt.url;
                                                            img.className = 'receipt-image';
                                                            img.alt = `ì˜ìˆ˜ì¦ ${index + 1}`;

                                                            // ì˜ìˆ˜ì¦ ì´ë¯¸ì§€ í´ë¦­ ì´ë²¤íŠ¸ (ê°œë³„ ë‹¤ìš´ë¡œë“œ)
                                                            img.onclick = function() {
                                                                const filename = `${data.name}_ì˜ìˆ˜ì¦${index + 1}.jpg`;
                                                                downloadImage(receipt.url, filename);
                                                            };

                                                            imgContainer.appendChild(img);
                                                            receiptImages.appendChild(imgContainer);
                                                        }
                                                    });

                                                    // ëª¨ë“  ì˜ìˆ˜ì¦ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
                                                    downloadAllReceipts.onclick = async function() {
                                                        let success = true;
                                                        for (let i = 0; i < data.receipts.length; i++) {
                                                            if (data.receipts[i].url) {
                                                                const result = await downloadImage(data.receipts[i].url, `${data.name}_ì˜ìˆ˜ì¦${i + 1}.jpg`);
                                                                if (!result) success = false;
                                                            }
                                                        }

                                                        if (success) {
                                                            showNotification('ëª¨ë“  ì˜ìˆ˜ì¦ë‹¤ìš´ë¡œë“œ ì™„ë£Œ', 'success');
                                                        }
                                                    };
                                                } else {
                                                    showNotification('ì˜ìˆ˜ì¦ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                                                }
                                            } else {
                                                showNotification('ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                                            }
                                        } catch (error) {
                                            console.error('ì˜ìˆ˜ì¦ ë¡œë”© ì¤‘ ì˜¤ë¥˜:', error);
                                            showNotification('ì˜ìˆ˜ì¦ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                                        }
                                    });
                                });

                                // ê³„ì•½ì„œ ë³´ê¸° ë²„íŠ¼ì€ ì´ì œ a íƒœê·¸ë¡œ ì§ì ‘ ì´ë¯¸ì§€ URLì— ì—°ê²°ë©ë‹ˆë‹¤
                            }
                        } catch (error) {
                            console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                            resultMessage.innerHTML = 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                            showNotification('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                        } finally {
                            // ë¡œë”© í‘œì‹œ ì œê±°
                            searchBtn.disabled = false;
                            searchBtn.innerHTML = 'ê³„ì•½ì„œ ì¡°íšŒ';
                        }
                    });

                    // ì…ë ¥ í•„ë“œì—ì„œ Enter í‚¤ ì´ë²¤íŠ¸
                    nameInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            searchBtn.click();
                        }
                    });

                    birthdateInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            searchBtn.click();
                        }
                    });

                    // í¼ ì „ì²´ì— Enter í‚¤ ì´ë²¤íŠ¸ ì¶”ê°€
                    document.querySelector('.card').addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            searchBtn.click();
                        }
                    });

                    // ìƒë…„ì›”ì¼ ì…ë ¥ ì œí•œ (ìˆ«ìë§Œ, ìµœëŒ€ 8ì)
                    birthdateInput.addEventListener('input', function () {
                        let value = this.value.replace(/\D/g, '');

                        if (value.length > 8) {
                            value = value.substring(0, 8);
                        }

                        this.value = value;
                    });

                    // Add click handler to logo for returning home
                    document.querySelector('.logo-container').addEventListener('click', function() {
                        window.location.href = "./index.html";
                    });
                }
    </script>
</body>

</html>