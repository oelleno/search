<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="language" content="ko">
    <title>계약서 조회</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <style>
        /* 로고 반짝이는 효과 */
        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .logo-container {
            position: relative;
            display: inline-block;
        }

        .logo-container::after {
            content: "";
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(90deg,
                    rgba(192, 192, 192, 0) 0%,
                    rgba(192, 192, 192, 0.1) 20%,
                    rgba(211, 211, 211, 0.5) 50%,
                    rgba(192, 192, 192, 0.1) 80%,
                    rgba(192, 192, 192, 0) 100%);
            background-size: 200% 100%;
            border-radius: 10px;
            z-index: 1;
            animation: shimmer 5s infinite linear;
            pointer-events: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            min-width: 250px;
        }

        .notification.success {
            background-color: #28a745;
        }

        .notification.error {
            background-color: #dc3545;
        }

        .notification.show {
            opacity: 1;
        }

        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin-top: -150px;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        .card-body {
            padding: 2rem;
        }

        .btn {
            width: 100%;
            margin-bottom: 1rem;
            padding: 1rem;
            font-size: 1.1rem;
        }

        .image-preview {
            max-width: 100%;
            max-height: 500px;
            margin-top: 1rem;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            display: none;
            object-fit: contain;
        }

        #search-results {
            margin-top: 1rem;
        }

        .receipt-preview {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .receipt-image {
            max-width: 100%;
            height: 150px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        /* Mobile responsive styles */
        @media (max-width: 480px) {
            .card {
                max-width: 90%;
                margin: 0 auto;
            }

            .receipt-image {
                height: 100px;
            }
        }

        /* Tablet responsive styles */
        @media (min-width: 481px) and (max-width: 1024px) {
            .receipt-image {
                height: 120px;
            }
        }
        .result-item {
            border: 1px solid #ccc;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

    </style>
</head>

<body>
    <div class="container">
        <div class="card">
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="logo-container">
                        <img src="BDSR.png" alt="BDSR 로고"
                            style="max-width: 150px; margin: 20px 10px;  position: relative; z-index: 2;">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">이름</label>
                    <input type="text" class="form-control" id="name" placeholder="이름을 입력하세요">
                </div>

                <div class="mb-3 row">
                    <div class="col-6">
                        <label class="form-label">생년월일</label>
                        <input type="text" class="form-control" id="birthdate" placeholder="예: 19901010">
                    </div>
                    <div class="col-6">
                        <label class="form-label">관리자 코드</label>
                        <input type="password" class="form-control" id="admin-code" placeholder="관리자 코드 입력">
                    </div>
                </div>
                <div class="mb-3 text-center" style="font-size: 0.8rem; color: #6c757d;">
                    * 생년월일 또는 관리자 코드 중 하나는 필수 입력입니다
                </div>

                <button id="search-btn" class="btn btn-primary">계약서 조회</button>

                <div id="search-results" class="mt-4" style="display: none;">
                    <div id="results-section" style="display: none;">
                        <div id="results-container"></div>
                    </div>
                    <div class="alert alert-info" id="result-message"></div>

                    <div id="contract-section" style="display: none;">
                        <img id="contract-image" class="image-preview" style="display: block;">
                        <button id="download-contract" class="btn btn-success mt-2">계약서 다운로드</button>
                    </div>

                    <div id="receipts-section" style="display: none;">
                        <div id="receipt-images" class="receipt-preview"></div>
                        <button id="download-all-receipts" class="btn btn-success mt-2">영수증 다운로드</button>
                    </div>
                </div>
                <div id="status"></div>
                <div class="d-flex justify-content-center">

                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase 설정 가져오기
        let db, storage;

        async function initializeFirebase() {
            try {
                const response = await fetch("https://us-central1-bodystar-1b77d.cloudfunctions.net/getFirebaseConfig");
                const firebaseConfig = await response.json();
                console.log("Firebase 설정 가져오기 성공");

                // Firebase 초기화
                const app = firebase.initializeApp(firebaseConfig, "search-app-instance");
                db = firebase.firestore(app);
                storage = firebase.storage(app);

                console.log("✅ Firestore 초기화 완료: Firestore");
                console.log("✅ Firebase Auth 초기화 완료: AuthImpl");

                return true;
            } catch (error) {
                console.error("Firebase 설정 가져오기 오류:", error);
                if (document.getElementById("status")) {
                    document.getElementById("status").innerText = "Firebase 연결 오류가 발생했습니다.";
                }
                throw error;
            }
        }

        // DOM이 완전히 로드된 후에 Firebase 초기화와 이벤트 리스너 설정
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                await initializeFirebase();
                // 약간의 지연을 주어 모든 요소가 완전히 로드되도록 함
                setTimeout(() => {
                    setupEventListeners();
                }, 100);
            } catch (error) {
                console.error("Firebase 초기화 오류:", error);
                if (document.getElementById("status")) {
                    document.getElementById("status").innerText = "Firebase 연결 오류가 발생했습니다.";
                }
            }
        });

        // 알림 표시 함수
        function showNotification(message, type) {
            // Check if notification element already exists
            let notification = document.getElementById('notification');

            // If not, create it
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                notification.className = 'notification';
                document.body.appendChild(notification);
            }

            // Add appropriate class for styling
            notification.className = 'notification ' + type;

            // Set notification content
            notification.innerHTML = message;

            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);

            // Hide after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // 이미지 다운로드 함수
        async function downloadImage(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
                return true;
            } catch (error) {
                console.error('다운로드 오류:', error);
                showNotification('이미지 다운로드 중 오류가 발생했습니다.', 'error');
                return false;
            }
        }

        // 날짜 포맷 변환 (YYYY-MM-DD -> YYMMDD)
        function formatDateForSearch(dateString) {
            if (!dateString) return null;

            // 숫자만 남기고 길이 확인
            const digits = dateString.replace(/\D/g, '');

            if (digits.length === 8) {
                // YYYYMMDD -> YYYY-MM-DD 변환
                return `${digits.substring(0, 4)}-${digits.substring(4, 6)}-${digits.substring(6, 8)}`;
            }

            return null;
        }


        function setupEventListeners() {
                const searchBtn = document.getElementById('search-btn');
                const nameInput = document.getElementById('name');
                const birthdateInput = document.getElementById('birthdate');
                const searchResults = document.getElementById('search-results');
                const resultMessage = document.getElementById('result-message');
                const contractSection = document.getElementById('contract-section');
                const contractImage = document.getElementById('contract-image');
                const downloadContract = document.getElementById('download-contract');
                const receiptsSection = document.getElementById('receipts-section');
                const receiptImages = document.getElementById('receipt-images');
                const downloadAllReceipts = document.getElementById('download-all-receipts');
                const returnHomeBtn = document.getElementById('return-home');
                const resultsSection = document.getElementById('results-section');
                const resultsContainer = document.getElementById('results-container'); // Added

                // 검색 버튼 클릭 이벤트
                searchBtn.addEventListener('click', async function () {
                    const name = nameInput.value.trim();
                    let birthdate = birthdateInput.value.trim();

                    if (!name) {
                        showNotification('이름을 입력해주세요.', 'error');
                        return;
                    }

                    const adminCode = document.getElementById('admin-code').value.trim();
                    if (!birthdate && !adminCode) {
                        showNotification('생년월일 또는 관리자코드 중 하나는 필수입니다.', 'error');
                        return;
                    }

                    // 🔹 생년월일을 Firestore 저장 형식 (YYYY-MM-DD)으로 변환
                    if (birthdate) {
                        birthdate = formatDateForSearch(birthdate);
                    }

                    try {
                        let query;

                        if (birthdate) {
                            // 🔹 이름 + 변환된 생년월일로 검색
                            query = db.collection("Membership").where("name", "==", name).where("birthdate", "==", birthdate);
                        } else if (adminCode) {
                            // 🔹 이름 + 관리자 코드로 검색 (이름만 매치)
                            query = db.collection("Membership").where("name", "==", name);
                        }

                        if (!query) {
                            throw new Error('검색 조건이 설정되지 않았습니다.');
                        }

                        const querySnapshot = await query.get();
                    } catch (error) {
                        console.error('검색 오류:', error);
                        showNotification('검색 중 오류가 발생했습니다.', 'error');
                        return;
                    }


                        // 검색 결과 초기화
                        searchResults.style.display = 'block'; //Always show search results container
                        resultsSection.style.display = 'none'; //Initially hide results
                        contractSection.style.display = 'none';
                        receiptsSection.style.display = 'none';
                        contractImage.src = '';
                        contractImage.style.display = 'none'; // 이미지 표시 초기화
                        receiptImages.innerHTML = '';
                        resultsContainer.innerHTML = ''; //Clear previous results
                        resultMessage.innerHTML = ''; //Clear previous messages


                        // 로딩 표시
                        searchBtn.disabled = true;
                        searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 검색 중...';

                        try {
                            console.log('검색 시작:', name, birthdate);
                            // 검색 중 팝업 제거

                            // 로그에 접근 토큰 출력 (인증 이슈 확인용)
                            storage.ref().toString();

                            // 현재 연도 가져오기 (2023부터 시작으로 확장)
                            const startYear = 2023;
                            const currentYear = new Date().getFullYear();
                            const years = [];

                            // 2023년부터 현재 연도까지의 배열 생성
                            for (let year = startYear; year <= currentYear; year++) {
                                years.push(year.toString());
                            }

                            // AdminSettings에서 지점 목록을 가져옴
                            const branchesSnapshot = await db.collection("AdminSettings").doc("settings").get();
                            let branches = ["관저점", "유성점", "둔산점", "도안점", "노은점", "진잠점", "대전센터"]; // 기본값

                            if (branchesSnapshot.exists) {
                                const settingsData = branchesSnapshot.data();
                                if (settingsData && settingsData.branch) {
                                    branches = Object.keys(settingsData.branch);
                                    console.log("AdminSettings에서 지점 목록 로드:", branches);
                                } else {
                                    console.warn("AdminSettings에 branch 데이터가 없습니다. 기본값 사용");
                                }
                            } else {
                                console.warn("AdminSettings/settings 문서를 찾을 수 없습니다. 기본값 사용");
                            }

                            // 결과를 담을 배열
                            const filteredResults = [];

                            // 각 지점과 연도 조합으로 검색
                            for (const branch of branches) {
                                for (const year of years) {
                                    try {
                                        // 새 폴더 구조에 맞게 여러 컬렉션 조회
                                        // 1. Membership 컬렉션 (기본)
                                        const queryMembership = db.collection(branch).doc(year).collection("Membership").where("name", "==", name);
                                        const querySnapshotMembership = await queryMembership.get();

                                        if (!querySnapshotMembership.empty) {
                                            console.log(`${branch}/${year}/Membership 검색 결과:`, querySnapshotMembership.size);

                                            querySnapshotMembership.forEach((doc) => {
                                                const data = doc.data();
                                                console.log('Membership 문서 데이터:', data.name, data.birthdate);

                                                // 생년월일 포맷팅 및 로깅 추가
                                                console.log(`비교: DB데이터(${data.birthdate}) vs 입력데이터(${birthdate})`);
                                                const cleanDBBirthdate = data.birthdate ? data.birthdate.replace(/[^0-9]/g, '') : '';
                                                const cleanInputBirthdate = birthdate ? birthdate.replace(/[^0-9]/g, '') : '';

                                                // 만약 DB의 생년월일이 8자리(YYYYMMDD)인데, 입력은 6자리(YYMMDD)인 경우 형식 통일
                                                let formattedDBBirthdate = cleanDBBirthdate;
                                                if (cleanDBBirthdate.length === 8 && cleanInputBirthdate.length === 6) {
                                                    formattedDBBirthdate = cleanDBBirthdate.substring(2); // YYYYMMDD -> YYMMDD
                                                }

                                                console.log(`정제된 비교: DB(${cleanDBBirthdate} -> ${formattedDBBirthdate}) vs 입력(${cleanInputBirthdate})`);

                                                // 관리자 코드 확인
                                                const adminCode = document.getElementById('admin-code').value.trim();

                                                // 생년월일 검증 로직
                                                // 1. 관리자 코드가 있으면 생년월일 검증 없이 통과
                                                // 관리자 코드가 있거나 생년월일이 일치하는 경우에만 결과에 포함
                                                if (adminCode || 
                                                    (cleanInputBirthdate && cleanDBBirthdate && (
                                                        cleanDBBirthdate === cleanInputBirthdate || 
                                                        formattedDBBirthdate === cleanInputBirthdate
                                                    ))) {
                                                    console.log(`✅ 일치: ${data.name} (${data.birthdate})`);
                                                    filteredResults.push({doc, data});
                                                } else {
                                                    console.log(`❌ 불일치: ${data.name} - 생년월일이 다릅니다`);
                                                }
                                            });
                                        }

                                        // Onetimepass 컬렉션은 제외하고 Membership 컬렉션에서만 검색합니다
                                        console.log(`${branch}/${year} Membership 컬렉션에서만 검색합니다`);
                                    } catch (error) {
                                        console.log(`${branch}/${year} 검색 중 오류:`, error);
                                        // 오류가 발생해도 계속 진행
                                    }
                                }
                            }

                            // 폴더구조 변경 전 기존 데이터도 검색 (마이그레이션 기간 중)
                            try {
                                const legacyQuery = db.collection("Membership").where("name", "==", name);
                                const legacyQuerySnapshot = await legacyQuery.get();

                                if (!legacyQuerySnapshot.empty) {
                                    console.log('기존 구조에서 검색 결과:', legacyQuerySnapshot.size);

                                    try {
                                        legacyQuerySnapshot.forEach((doc) => {
                                            const data = doc.data();
                                            console.log('기존 문서 데이터:', data.name, data.birthdate);

                                            // 생년월일 포맷팅 및 로깅 추가
                                            console.log(`비교: DB데이터(${data.birthdate}) vs 입력데이터(${birthdate})`);

                                            // 생년월일 데이터 정제 (숫자만 추출)
                                            const cleanDBBirthdate = data.birthdate ? data.birthdate.replace(/[^0-9]/g, '') : '';
                                            const cleanInputBirthdate = birthdate ? birthdate.replace(/[^0-9]/g, '') : '';

                                            // 만약 DB의 생년월일이 8자리(YYYYMMDD)인데, 입력은 6자리(YYMMDD)인 경우 형식 통일
                                            let formattedDBBirthdate = cleanDBBirthdate;
                                            if (cleanDBBirthdate.length === 8 && cleanInputBirthdate.length === 6) {
                                                formattedDBBirthdate = cleanDBBirthdate.substring(2); // YYYYMMDD -> YYMMDD
                                            }

                                            // 관리자 코드 확인
                                            const adminCode = document.getElementById('admin-code').value.trim();

                                            // 생년월일 검증 로직
                                            // 1. 관리자 코드가 있으면 생년월일 검증 없이 통과
                                            // 2. 정확히 일치하는 경우
                                            // 3. 형식을 통일했을 때 일치하는 경우
                                            if (adminCode) {
                                                console.log(`✅ 관리자 코드 입력됨 -> 이름만 매칭됨`);
                                                filteredResults.push({doc, data});
                                            } else {
                                                if (!cleanInputBirthdate) {
                                                    console.log(`❌ 생년월일 미입력 -> 결과에서 제외`);
                                                } else if (!cleanDBBirthdate) {
                                                    console.log(`❌ 데이터베이스에 생년월일 없음 -> 결과에서 제외`);
                                                } else if (cleanDBBirthdate === cleanInputBirthdate || formattedDBBirthdate === cleanInputBirthdate) { 
                                                    console.log(`✅ 이름 + 생년월일 매칭됨: ${data.name} (${data.birthdate})`);
                                                    filteredResults.push({doc, data});
                                                } else {
                                                    console.log(`❌ 생년월일 불일치 -> 결과에서 제외`);
                                                }
                                            }

                                        });
                                    } catch (error) {
                                        console.error("Error processing legacyQuerySnapshot:", error);
                                    }
                                }

                                // 문서 ID로 직접 검색 시도 (날짜_번호_이름 형식)
                                console.log("문서 ID로 직접 검색 시도...");
                                // 각 지점 순회
                                for (const branch of branches) {
                                    for (const year of years) {
                                        try {
                                            // 이름으로 시작하는 문서 찾기
                                            const snapshots = await db.collection(branch).doc(year).collection("Membership")
                                                .where("name", "==", name)
                                                .get();

                                            if (!snapshots.empty) {
                                                console.log(`${branch}/${year} 문서 ID로 검색 결과:`, snapshots.size);
                                                snapshots.forEach(doc => {
                                                    const data = doc.data();
                                                    // 이미 결과에 추가되지 않았으면 추가
                                                    if (!filteredResults.some(item => item.doc.id === doc.id)) {
                                                        console.log(`문서 ID로 찾음: ${doc.id}`);
                                                        filteredResults.push({doc, data});
                                                    }
                                                });
                                            }
                                        } catch (error) {
                                            console.log(`${branch}/${year} 문서 ID 검색 중 오류:`, error);
                                        }
                                    }
                                }
                            } catch (error) {
                                console.log('기존 구조 검색 중 오류:', error);
                                // 오류가 발생해도 계속 진행
                            }

                            if (filteredResults.length === 0) {
                                resultMessage.innerHTML = '검색 결과가 없습니다.';
                                resultMessage.style.display = 'block';
                                // Notification popup removed as requested
                            } else {
                                let foundResults = filteredResults.length;
                                resultMessage.innerHTML = `${foundResults}개의 결과를 찾았습니다.`;
                                resultMessage.style.display = 'block';
                                // 3초 후에 결과 메시지 숨기기
                                setTimeout(() => {
                                    resultMessage.style.display = 'none';
                                }, 3000);

                                // 각 결과에 대해 처리
                                let resultsHTML = '';
                                filteredResults.forEach(({doc, data}) => {
                                    const membershipDate = data.timestamp ? new Date(data.timestamp).toLocaleDateString('ko-KR') : '날짜 정보 없음';

                                    // imageUrl 정보 추출
                                    const hasImage = data.imageUrl ? true : false;

                                    resultsHTML += `
                                    <div class="result-item" data-docid="${doc.id}" data-collection="${data.collection || 'Membership'}" data-imageurl="${data.imageUrl || ''}">
                                        <div class="result-header">
                                            <h5>${data.name} (${data.birthdate || '생년월일 정보 없음'})</h5>
                                            <span class="badge bg-primary">${data.branch || '지점 정보 없음'}</span>
                                            <span class="badge ${hasImage ? 'bg-success' : 'bg-danger'}">${hasImage ? '이미지 있음' : '이미지 없음'}</span>
                                        </div>
                                        <p><strong>문서 ID:</strong> ${doc.id}</p>
                                        <p><strong>연락처:</strong> ${data.contact || '연락처 정보 없음'}</p>
                                        <p><strong>등록일:</strong> ${membershipDate}</p>
                                        <p><strong>회원권:</strong> ${data.membership || '회원권 정보 없음'}</p>
                                        <p><strong>주소:</strong> ${data.address || '주소 정보 없음'}</p>
                                        <div class="action-buttons" style="width: 100%; justify-content: space-between;">
                                            ${hasImage ? 
                                              `<div style="display: flex; flex-direction: column; gap: 5px; margin-right: 10px; width: 48%;">
                                                 <a href="${data.imageUrl}" target="_blank" class="btn btn-primary btn-sm" style="width: 100%;">계약서 보기</a>
                                                 <button class="btn btn-info btn-sm download-contract-btn" data-url="${data.imageUrl}" data-name="${data.name}" style="width: 100%; padding-top: 0.25rem; padding-bottom: 0.25rem;">계약서 다운로드</button>
                                               </div>` : 
                                              `<div style="width: 48%;"><button class="btn btn-secondary btn-sm" disabled style="width: 100%;">계약서 없음</button></div>`
                                            }
                                            <div style="display: flex; flex-direction: column; gap: 5px; width: 48%;">
                                              <button class="btn btn-primary btn-sm view-receipt-btn" style="width: 100%;">영수증 보기</button>
                                              <button class="btn btn-info btn-sm download-receipt-btn" style="width: 100%; padding-top: 0.25rem; padding-bottom: 0.25rem;">영수증 다운로드</button>
                                            </div>
                                        </div>
                                    </div>
                                    `;
                                });

                                resultsContainer.innerHTML = resultsHTML;
                                resultsSection.style.display = 'block';

                                // 계약서 다운로드 버튼에 이벤트 리스너 추가
                                document.querySelectorAll('.download-contract-btn').forEach(btn => {
                                    btn.addEventListener('click', function() {
                                        const url = this.dataset.url;
                                        const name = this.dataset.name;
                                        if (url) {
                                            downloadImage(url, `${name}_계약서.jpg`);
                                            showNotification('계약서 다운로드를 시작합니다.', 'success');
                                        } else {
                                            showNotification('계약서 이미지가 없습니다.', 'error');
                                        }
                                    });
                                });

                                // 영수증 다운로드 버튼에 이벤트 리스너 추가
                                document.querySelectorAll('.download-receipt-btn').forEach(btn => {
                                    btn.addEventListener('click', async function() {
                                        const resultItem = this.closest('.result-item');
                                        const docId = resultItem.dataset.docid;
                                        const collection = resultItem.dataset.collection || 'Membership';
                                        const name = resultItem.querySelector('h5').textContent.split(' ')[0];

                                        try {
                                            // 문서 데이터 가져오기
                                            const docRef = db.collection(collection).doc(docId);
                                            const docSnapshot = await docRef.get();

                                            if (docSnapshot.exists) {
                                                const data = docSnapshot.data();

                                                if (data.receipts && data.receipts.length > 0) {
                                                    // 모든 영수증 다운로드
                                                    let success = true;
                                                    for (let i = 0; i < data.receipts.length; i++) {
                                                        if (data.receipts[i].url) {
                                                            const result = await downloadImage(data.receipts[i].url, `${name}_영수증${i + 1}.jpg`);
                                                            if (!result) success = false;
                                                        }
                                                    }

                                                    if (success) {
                                                        showNotification('영수증 다운로드를 시작합니다.', 'success');
                                                    }
                                                } else {
                                                    showNotification('영수증이 없습니다.', 'error');
                                                }
                                            } else {
                                                showNotification('문서를 찾을 수 없습니다.', 'error');
                                            }
                                        } catch (error) {
                                            console.error('영수증 다운로드 중 오류:', error);
                                            showNotification('영수증 다운로드 중 오류가 발생했습니다.', 'error');
                                        }
                                    });
                                });

                                // 영수증 보기 버튼에 이벤트 리스너 추가
                                document.querySelectorAll('.view-receipt-btn').forEach(btn => {
                                    btn.addEventListener('click', async function() {
                                        const resultItem = this.closest('.result-item');
                                        const docId = resultItem.dataset.docid;
                                        const collection = resultItem.dataset.collection || 'Membership';

                                        // 영수증 섹션 초기화
                                        receiptImages.innerHTML = '';
                                        receiptsSection.style.display = 'none';

                                        try {
                                            // 문서 데이터 가져오기
                                            const docRef = db.collection(collection).doc(docId);
                                            const docSnapshot = await docRef.get();

                                            if (docSnapshot.exists) {
                                                const data = docSnapshot.data();

                                                if (data.receipts && data.receipts.length > 0) {
                                                    receiptsSection.style.display = 'block';

                                                    data.receipts.forEach((receipt, index) => {
                                                        if (receipt.url) {
                                                            const imgContainer = document.createElement('div');
                                                            const img = document.createElement('img');
                                                            img.src = receipt.url;
                                                            img.className = 'receipt-image';
                                                            img.alt = `영수증 ${index + 1}`;

                                                            // 영수증 이미지 클릭 이벤트 (개별 다운로드)
                                                            img.onclick = function() {
                                                                const filename = `${data.name}_영수증${index + 1}.jpg`;
                                                                downloadImage(receipt.url, filename);
                                                            };

                                                            imgContainer.appendChild(img);
                                                            receiptImages.appendChild(imgContainer);
                                                        }
                                                    });

                                                    // 모든 영수증 다운로드 버튼 이벤트
                                                    downloadAllReceipts.onclick = async function() {
                                                        let success = true;
                                                        for (let i = 0; i < data.receipts.length; i++) {
                                                            if (data.receipts[i].url) {
                                                                const result = await downloadImage(data.receipts[i].url, `${data.name}_영수증${i + 1}.jpg`);
                                                                if (!result) success = false;
                                                            }
                                                        }

                                                        if (success) {
                                                            showNotification('모든 영수증다운로드 완료', 'success');
                                                        }
                                                    };
                                                } else {
                                                    showNotification('영수증이 없습니다.', 'error');
                                                }
                                            } else {
                                                showNotification('문서를 찾을 수 없습니다.', 'error');
                                            }
                                        } catch (error) {
                                            console.error('영수증 로딩 중 오류:', error);
                                            showNotification('영수증 로딩 중 오류가 발생했습니다.', 'error');
                                        }
                                    });
                                });

                                // 계약서 보기 버튼은 이제 a 태그로 직접 이미지 URL에 연결됩니다
                            }
                        } catch (error) {
                            console.error('검색 오류:', error);
                            resultMessage.innerHTML = '검색 중 오류가 발생했습니다.';
                            showNotification('검색 중 오류가 발생했습니다.', 'error');
                        } finally {
                            // 로딩 표시 제거
                            searchBtn.disabled = false;
                            searchBtn.innerHTML = '계약서 조회';
                        }
                    });

                    // 입력 필드에서 Enter 키 이벤트
                    nameInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            searchBtn.click();
                        }
                    });

                    birthdateInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            searchBtn.click();
                        }
                    });

                    // 폼 전체에 Enter 키 이벤트 추가
                    document.querySelector('.card').addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            searchBtn.click();
                        }
                    });

                    // 생년월일 입력 제한 (숫자만, 최대 8자)
                    birthdateInput.addEventListener('input', function () {
                        let value = this.value.replace(/\D/g, '');

                        if (value.length > 8) {
                            value = value.substring(0, 8);
                        }

                        this.value = value;
                    });

                    // Add click handler to logo for returning home
                    document.querySelector('.logo-container').addEventListener('click', function() {
                        window.location.href = "./index.html";
                    });
                }
    </script>
</body>

</html>